@page "/"
@using LoveCards.Models
@inject LoveCards.Services.CardService Cards
@inject IJSRuntime JS

<div class="page">
    <header class="top">
        <div class="brand">Милая Даша</div>
    </header>

    <main class="content">
        
        @if (_current is null)
        {
            <button class="big-btn" @onclick="ShowDaily">
                Это пройдёт 💛
            </button>
        }

        @if (_current is not null)
        {
            <section class="card card-animate" @key="_cardRenderKey">
                <div class="hearts" aria-hidden="true">
                    <span class="heart h1">❤</span>
                    <span class="heart h2">❤</span>
                    <span class="heart h3">❤</span>
                    <span class="heart h4">❤</span>
                    <span class="heart h5">❤</span>
                    <span class="heart h6">❤</span>
                </div>

                <div class="card-title">@_current.Title</div>
                <div class="card-text">@_current.Text</div>

                @if (!string.IsNullOrWhiteSpace(_current.ActionHint))
                {
                    <div class="card-hint">✨ @_current.ActionHint</div>
                }

                <div class="card-sign">@_current.Signature</div>

                <div class="card-actions">
                    <button class="small-btn" @onclick="ShowBonus">Мне нужно ещё чуть-чуть</button>
                </div>
            </section>
        }
    </main>

    <footer class="footer">
        сделано с теплом ✨
    </footer>
    
    
    <div class="fx" aria-hidden="true">
        <div class="fx-shimmer"></div>
        <div class="glow-dust" id="glowDust"></div>
        <div class="petals" id="petals"></div>
    </div>
    
</div>

@code {
    private SupportCard? _current;
    private int _cardRenderKey = 0;
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("petalsFx.init");
        }
    }

    private async Task ShowDaily()
    {
        _current = await Cards.GetDailyCardAsync();
        _cardRenderKey++;
        await JS.InvokeVoidAsync("appHaptics.vibrate", 15);
        await JS.InvokeVoidAsync("petalsFx.gust", 85, 900); // сила, длительность мс
    }

    private async Task ShowBonus()
    {
        _current = await Cards.GetBonusCardAsync();
        _cardRenderKey++;
        await JS.InvokeVoidAsync("appHaptics.vibrate", 10);
        await JS.InvokeVoidAsync("petalsFx.gust", 55, 650);
    }
}